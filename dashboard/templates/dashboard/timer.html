{% extends 'dashboard/base.html' %}
{% block content %}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6 text-center">
            <div class="card modern-card shadow-lg p-5 border-0" style="border-radius: 30px;">
                <h2 class="font-weight-bold text-primary mb-4">Focus Timer</h2>
                
                <div class="timer-container position-relative mx-auto mb-4">
                    <svg class="timer-svg" viewBox="0 0 100 100">
                        <circle class="timer-path-remaining" cx="50" cy="50" r="45"></circle>
                    </svg>
                    <span id="timer-label" class="timer-display">25:00</span>
                </div>

                <div class="d-flex justify-content-center gap-3">
                    <button id="start-btn" class="btn btn-primary btn-lg rounded-pill px-4 shadow-sm">
                        <i class="fas fa-play mr-2"></i>Start
                    </button>
                    <button id="pause-btn" class="btn btn-outline-secondary btn-lg rounded-pill px-4 d-none">
                        <i class="fas fa-pause mr-2"></i>Pause
                    </button>
                    <button id="reset-btn" class="btn btn-light btn-lg rounded-pill px-4">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>

                <div class="mt-5 pt-3 border-top">
                    <div class="btn-group w-100">
                        <button class="btn btn-sm btn-outline-primary active" onclick="setTimer(25)">Study</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="setTimer(5)">Short Break</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="setTimer(15)">Long Break</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .timer-container { width: 250px; height: 250px; }
    .timer-display {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3.5rem; font-weight: 800; color: #333;
    }
    .timer-svg { transform: rotate(-90deg); }
    .timer-path-remaining {
        fill: none; stroke: #4f46e5; stroke-width: 5px;
        stroke-dasharray: 283; stroke-linecap: round;
        transition: stroke-dashoffset 1s linear;
    }
    .gap-3 { gap: 1rem; }
</style>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<script>
    let timeLeft = 1500; // 25 minutes
    let timerId = null;
    let totalTime = 1550;

    const label = document.getElementById('timer-label');
    const path = document.querySelector('.timer-path-remaining');
    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const beep = document.getElementById('beep');

    // --- NEW: Request Permission when the page loads ---
    document.addEventListener('DOMContentLoaded', () => {
        if ("Notification" in window) {
            if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }
    });

    function updateDisplay() {
        let mins = Math.floor(timeLeft / 60);
        let secs = timeLeft % 60;
        label.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        
        const offset = 283 - (timeLeft / totalTime) * 283;
        path.style.strokeDashoffset = offset;
    }

    function startTimer() {
        if (timerId) return;
        startBtn.classList.add('d-none');
        pauseBtn.classList.remove('d-none');
        
        timerId = setInterval(() => {
            timeLeft--;
            updateDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerId);
                beep.play();

                // --- NEW: Trigger Desktop Notification ---
                if ("Notification" in window && Notification.permission === "granted") {
                    new Notification("Time's Up! â°", {
                        body: "Focus session complete. Take a well-deserved break!",
                        icon: "https://cdn-icons-png.flaticon.com/512/2553/2553381.png" 
                    });
                } else {
                    // Fallback to standard alert if notifications are blocked/unsupported
                    alert("Time is up! Take a break.");
                }

                resetTimer();
            }
        }, 1000);
    }

    function pauseTimer() {
        clearInterval(timerId);
        timerId = null;
        startBtn.classList.remove('d-none');
        pauseBtn.classList.add('d-none');
    }

    function resetTimer() {
        pauseTimer();
        timeLeft = totalTime;
        updateDisplay();
    }

    function setTimer(mins) {
        totalTime = mins * 60;
        timeLeft = totalTime;
        updateDisplay();
        
        // Visual feedback for active button
        const buttons = document.querySelectorAll('.btn-group .btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    startBtn.onclick = startTimer;
    pauseBtn.onclick = pauseTimer;
    document.getElementById('reset-btn').onclick = resetTimer;
</script>

{% endblock content %}

